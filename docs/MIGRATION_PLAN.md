# AI-Podcast 架构迁移计划

## 概述

**目标**: 在 6 个月内从 `ai_poadcast_main/` 迁移到模块化的 `ai_poadcast/` 架构

**当前状态**:
- 新架构 (`ai_poadcast/`): ~450 行，核心模块已就绪
- 旧架构 (`ai_poadcast_main/`): ~4,212 行，生产环境运行
- 测试覆盖率: 从 2.3% 提升中，目标 70%

**预期收益**:
- ✅ 更好的可测试性
- ✅ 更清晰的依赖关系
- ✅ 更容易扩展和维护
- ✅ 减少代码重复
- ✅ 更好的类型安全

---

## 迁移原则

1. **零停机**: 保持现有功能正常运行
2. **增量迁移**: 逐步迁移，每次一个模块
3. **测试驱动**: 先写测试，再迁移代码
4. **向后兼容**: 保留旧接口作为过渡
5. **文档先行**: 更新文档和示例

---

## 6 个月时间线

### 月度概览

| 月份 | 重点 | 关键交付物 | 完成度目标 |
|------|------|-----------|-----------|
| 月1 | 核心基础设施 | 配置、LLM、档案管理 | 新架构 30% |
| 月2 | 内容处理 | 提取器、验证器、收集器 | 新架构 50% |
| 月3 | 脚本生成 | Prompt构建、生成器 | 新架构 70% |
| 月4 | CLI和工作流 | 命令行界面、流水线 | 新架构 85% |
| 月5 | 测试和文档 | 测试覆盖率、文档完善 | 测试 70%+ |
| 月6 | 清理和优化 | 删除旧代码、性能优化 | 完成 100% |

---

## 详细计划

### 第 1 个月: 核心基础设施

**目标**: 建立坚实的基础模块

#### Week 1-2: 配置和LLM客户端
- [x] **完成 `config.py`** (已完成)
  - [x] Pydantic 配置管理
  - [x] 降级方案 (无 Pydantic)
  - [x] 环境变量加载
  - [x] 测试覆盖率 > 80%

- [x] **完成 LLM 客户端** (已完成)
  - [x] OpenAI 客户端
  - [x] DeepSeek 客户端
  - [x] Anthropic 客户端
  - [x] 工厂模式
  - [x] 测试覆盖率 > 85%

#### Week 3: 档案管理
- [x] **完成 `core/archive.py`** (已完成)
  - [x] 文章保存逻辑
  - [x] 元数据管理
  - [x] 日期目录结构
  - [x] 测试覆盖率 > 90%

#### Week 4: 索引管理
- [ ] **实现 `core/index.py`**
  - [ ] 索引创建和更新
  - [ ] URL 去重检查
  - [ ] 快速查询接口
  - [ ] 测试覆盖率 > 80%

**检查点 1**: 核心模块完成，测试覆盖率 > 80%

---

### 第 2 个月: 内容处理

**目标**: 迁移新闻采集和处理逻辑

#### Week 5-6: 要点提取器
- [x] **完成 `processors/extractor.py`** (已完成)
  - [x] 从 `batch_extract.py` 迁移逻辑
  - [x] 依赖注入 LLM 客户端
  - [x] 批量处理支持
  - [x] 进度回调

- [ ] **编写测试**
  - [ ] Mock LLM 测试
  - [ ] 边界情况测试
  - [ ] 批量处理测试
  - [ ] 测试覆盖率 > 85%

#### Week 7: 内容验证器
- [ ] **实现 `processors/validator.py`**
  - [ ] 内容质量检查
  - [ ] 字段验证
  - [ ] 重复检测
  - [ ] 测试覆盖率 > 80%

#### Week 8: 收集器
- [ ] **实现 `collectors/` 模块**
  - [ ] `rss.py`: 从 `collect_rss_feeds.py` 迁移
  - [ ] `web.py`: 通用网页抓取
  - [ ] 基类抽象
  - [ ] 测试覆盖率 > 75%

**检查点 2**: 内容处理模块完成，整体覆盖率 > 60%

---

### 第 3 个月: 脚本生成

**目标**: 迁移播客脚本生成流程

#### Week 9-10: Prompt 构建器
- [ ] **实现 `generators/prompt.py`**
  - [ ] 从 `prepare_stage3_prompt.py` 迁移
  - [ ] 模板系统
  - [ ] 参数化配置
  - [ ] 测试覆盖率 > 85%

#### Week 11: 脚本生成器
- [x] **完成 `generators/script.py`** (已有基础)
  - [ ] 增强功能
  - [ ] 文本过滤逻辑
  - [ ] 格式化输出
  - [ ] 测试覆盖率 > 80%

#### Week 12: 整合测试
- [ ] **端到端测试**
  - [ ] 完整生成流程测试
  - [ ] 不同场景测试
  - [ ] 性能测试

**检查点 3**: 脚本生成完成，覆盖率 > 65%

---

### 第 4 个月: CLI 和工作流

**目标**: 提供用户友好的命令行接口

#### Week 13-14: CLI 命令
- [ ] **增强 `cli.py`**
  - [ ] `aipod collect`: 采集新闻
  - [ ] `aipod extract`: 提取要点
  - [ ] `aipod script`: 生成脚本
  - [ ] `aipod pipeline`: 完整流程
  - [ ] 进度条和日志

#### Week 15: 工作流编排
- [ ] **实现工作流管理**
  - [ ] 从 `daily_workflow.py` 迁移核心逻辑
  - [ ] 阶段管理 (Stage 0-5)
  - [ ] 错误恢复
  - [ ] 状态持久化

#### Week 16: 向后兼容层
- [ ] **兼容层实现**
  - [ ] 包装旧脚本调用新模块
  - [ ] 渐进式替换
  - [ ] 弃用警告

**检查点 4**: CLI 可用，覆盖率 > 70%

---

### 第 5 个月: 测试和文档

**目标**: 达到生产环境质量标准

#### Week 17-18: 补充测试
- [ ] **提升测试覆盖率到 70%+**
  - [ ] 补充边界情况测试
  - [ ] 集成测试
  - [ ] 性能测试
  - [ ] Mock 外部依赖

#### Week 19: 文档完善
- [ ] **更新所有文档**
  - [ ] API 参考文档
  - [ ] 使用指南
  - [ ] 迁移指南 (给用户)
  - [ ] 故障排查

#### Week 20: 示例和教程
- [ ] **创建示例代码**
  - [ ] 基本使用示例
  - [ ] 高级配置示例
  - [ ] 自定义扩展示例
  - [ ] 完整工作流示例

**检查点 5**: 测试覆盖率 > 70%，文档完整

---

### 第 6 个月: 清理和优化

**目标**: 完成迁移，删除遗留代码

#### Week 21: 代码清理
- [ ] **迁移剩余功能**
  - [ ] TTS 集成
  - [ ] 发布流程
  - [ ] 监控和日志

#### Week 22: 性能优化
- [ ] **性能改进**
  - [ ] 异步采集 (aiohttp)
  - [ ] 缓存优化
  - [ ] 批处理优化
  - [ ] 内存优化

#### Week 23: 删除旧代码
- [ ] **清理 `ai_poadcast_main/`**
  - [ ] 备份到 `legacy/`
  - [ ] 更新所有引用
  - [ ] 更新 Makefile
  - [ ] 更新 CI/CD

#### Week 24: 发布和回顾
- [ ] **1.0 版本发布**
  - [ ] 变更日志
  - [ ] 发布说明
  - [ ] 标记版本
  - [ ] 庆祝 🎉

**检查点 6**: 迁移完成，旧代码删除

---

## 风险管理

### 高风险项

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 破坏现有功能 | 高 | 完整的测试覆盖，金丝雀部署 |
| 依赖冲突 | 中 | 版本锁定，虚拟环境 |
| 性能下降 | 中 | 性能基准测试，优化 |
| 团队学习曲线 | 低 | 文档和培训 |

### 回滚计划

每个阶段保留回滚点：
```bash
git tag migration-checkpoint-1  # 每个月打标签
```

---

## 成功指标

### 技术指标
- [ ] 测试覆盖率 ≥ 70%
- [ ] 所有核心功能迁移完成
- [ ] 旧代码行数 < 500 行（仅保留必要的 legacy）
- [ ] 性能不低于现有系统
- [ ] 零已知严重 bug

### 质量指标
- [ ] 所有公共 API 有文档
- [ ] 至少 10 个使用示例
- [ ] CI/CD 通过率 ≥ 95%
- [ ] 代码审查覆盖率 100%

### 可维护性指标
- [ ] 平均函数复杂度 < 10
- [ ] 模块耦合度 < 30%
- [ ] 文档覆盖率 ≥ 80%
- [ ] 类型注解覆盖率 ≥ 90%

---

## 每周例会议程

1. **回顾上周进度**
2. **检查当前里程碑**
3. **识别阻塞问题**
4. **更新风险登记**
5. **规划下周任务**

---

## 沟通计划

- **每周**: 团队同步会议
- **每月**: 检查点评审
- **重要变更**: 邮件通知
- **问题追踪**: GitHub Issues

---

## 资源需求

- **人力**: 1-2 名工程师
- **时间**: 每周 20-30 小时
- **工具**:
  - pytest, pytest-cov
  - mypy (类型检查)
  - black (代码格式化)
  - pre-commit hooks

---

## 依赖项

### 外部依赖
- Python 3.9+
- 所有现有依赖保持不变
- 可选：pydantic 2.0+

### 内部依赖
- 阶段 2 依赖阶段 1
- 阶段 3 依赖阶段 1-2
- 阶段 4 依赖所有前置阶段

---

## 附录

### A. 模块对应关系

| 旧模块 | 新模块 | 优先级 |
|--------|--------|--------|
| `batch_extract.py` | `processors/extractor.py` | ✅ 已完成 |
| `collect_rss_feeds.py` | `collectors/rss.py` | 🔴 P0 |
| `generate_stage3_script.py` | `generators/script.py` | 🟡 P1 |
| `prepare_stage3_prompt.py` | `generators/prompt.py` | 🟡 P1 |
| `daily_workflow.py` | `cli.py` + workflow | 🟢 P2 |
| `process_queue.py` | `processors/` + CLI | 🟢 P2 |

### B. 废弃模块清单

以下模块将在迁移后移至 `legacy/` 或删除：
- `scrape_exam_sites.py` → 考虑重构或删除
- `gdelt_monitor.py` → 评估是否保留
- `resource_monitor.py` → 移至工具模块

### C. 新增模块计划

迁移期间计划添加的新模块：
- `ai_poadcast/tts/` → TTS 客户端抽象
- `ai_poadcast/publishers/` → 发布平台集成
- `ai_poadcast/monitoring/` → 监控和指标

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| 0.1 | 2025-01-15 | 初始版本 |
| 0.2 | TBD | 根据第一个月实际情况更新 |

---

**维护者**: AI Podcast Team
**最后更新**: 2025-01-15
**状态**: 🟡 进行中 (Month 1, Week 4)
